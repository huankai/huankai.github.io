<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Huangkai,huankai"><title>Redis 主从复制 | HuangkaiのBlog</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Redis 主从复制</h1><a id="logo" href="/.">HuangkaiのBlog</a><p class="description">学而不思则罔 思而不学则殆</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Redis 主从复制</h1><div class="post-meta"><a href="/2018/07/09/Redis_06_主从复制(哨兵机制)/#comments" class="comment-count"></a><p><span class="date">Jul 09, 2018</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p>redis复制的非常重要特性(摘自官网)：</p>
<ul>
<li>一个Master可以有多个Slaves</li>
<li>Slaves能过接受其他slave的链接，除了可以接受同一个master下面slaves的链接以外，还可以接受同一个结构图中的其他slaves的链接</li>
<li>redis复制是在master段是非阻塞的，这就意味着master在同一个或多个slave端执行同步的时候还可以接受查询</li>
<li>复制在slave端也是非阻塞的，假设你在redis.conf中配置redis这个功能，当slave在执行的新的同步时，它仍可以用旧的数据信息来提供查询，否则，你可以配置当redis slaves去master失去联系时，slave会给发送一个客户端错误</li>
<li>为了有多个slaves可以做只读查询，复制可以重复2次，甚至多次，具有可扩展性</li>
<li>通过复制可以避免master全量写硬盘的消耗：只要配置 master 的配置文件redis.conf来“避免保存”（注释掉所有”save”命令），然后连接一个用来持久化数据的slave即可。但是这样要确保masters 不会自动重启。</li>
</ul>
<p>一主两从配置Redis主从复制:服务如下</p>
<p>master ： 192.168.1.90 6379<br>slaveof : 192.168.1.90 6380<br>slaveof : 192.168.1.90 6381</p>
<h2 id="1、-创建配置文件"><a href="#1、-创建配置文件" class="headerlink" title="1、 创建配置文件"></a>1、 创建配置文件</h2><p>创建 redis_6380.conf 与  redis_6381.conf配置文件<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@huangkai <span class="keyword">conf</span>]# <span class="keyword">pwd</span></span><br><span class="line">/usr/local/redis-<span class="number">4.0</span>.<span class="number">1</span>/<span class="keyword">conf</span></span><br><span class="line">[root@huangkai <span class="keyword">conf</span>]# <span class="keyword">ll</span></span><br><span class="line">total <span class="number">60</span></span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">57777</span> Oct <span class="number">29</span> <span class="number">02</span>:<span class="number">17</span> redis.<span class="keyword">conf</span></span><br><span class="line">[root@huangkai <span class="keyword">conf</span>]# <span class="keyword">cp</span> redis.<span class="keyword">conf</span> redis_6380.<span class="keyword">conf</span></span><br><span class="line">[root@huangkai <span class="keyword">conf</span>]# <span class="keyword">cp</span> redis.<span class="keyword">conf</span> redis_6381.<span class="keyword">conf</span>  </span><br><span class="line">[root@huangkai <span class="keyword">conf</span>]# <span class="keyword">ll</span></span><br><span class="line">total <span class="number">180</span></span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">57777</span> Nov  <span class="number">6</span> <span class="number">21</span>:<span class="number">44</span> redis_6380.<span class="keyword">conf</span></span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">57777</span> Nov  <span class="number">6</span> <span class="number">21</span>:<span class="number">44</span> redis_6381.<span class="keyword">conf</span></span><br><span class="line">-rw-r--r--. <span class="number">1</span> root root <span class="number">57777</span> Oct <span class="number">29</span> <span class="number">02</span>:<span class="number">17</span> redis.<span class="keyword">conf</span></span><br><span class="line">[root@huangkai <span class="keyword">conf</span>]#</span><br></pre></td></tr></table></figure></p>
<h2 id="2、修改配置文件"><a href="#2、修改配置文件" class="headerlink" title="2、修改配置文件"></a>2、修改配置文件</h2><p>redis.conf默认配置不用修改。</p>
<p>redis_6380.conf修改如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">..</span>.</span><br><span class="line">port 6380</span><br><span class="line">pidfile /var/run/redis_6380.pid</span><br><span class="line">logfile <span class="string">"redis_6380.log"</span></span><br><span class="line">dbfilename dump_6380.rdb</span><br><span class="line"><span class="comment"># appendfilename "appendonly_6380.aof" appendonly持久化未开启，可不修改</span></span><br><span class="line"><span class="built_in">..</span>.</span><br></pre></td></tr></table></figure></p>
<p>redis_6381.conf修改如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">..</span>.</span><br><span class="line">port 6381</span><br><span class="line">pidfile /var/run/redis_6381.pid</span><br><span class="line">logfile <span class="string">"redis_6381.log"</span></span><br><span class="line">dbfilename dump_6381.rdb</span><br><span class="line"><span class="comment"># appendfilename "appendonly_6381.aof" appendonly持久化未开启，可不修改</span></span><br><span class="line"><span class="built_in">..</span>.</span><br></pre></td></tr></table></figure></p>
<h2 id="3、启动三台Redis服务"><a href="#3、启动三台Redis服务" class="headerlink" title="3、启动三台Redis服务"></a>3、启动三台Redis服务</h2><p>启动 6379</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@huangkai conf]<span class="comment"># redis-server ./redis.conf </span></span><br><span class="line"><span class="number">948</span><span class="symbol">:C</span> <span class="number">06</span> Nov <span class="number">21</span><span class="symbol">:</span><span class="number">52</span><span class="symbol">:</span><span class="number">07</span>.<span class="number">639</span> <span class="comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></span><br><span class="line"><span class="number">948</span><span class="symbol">:C</span> <span class="number">06</span> Nov <span class="number">21</span><span class="symbol">:</span><span class="number">52</span><span class="symbol">:</span><span class="number">07</span>.<span class="number">639</span> <span class="comment"># Redis version=4.0.1, bits=64, commit=00000000, modified=0, pid=948, just started</span></span><br><span class="line"><span class="number">948</span><span class="symbol">:C</span> <span class="number">06</span> Nov <span class="number">21</span><span class="symbol">:</span><span class="number">52</span><span class="symbol">:</span><span class="number">07</span>.<span class="number">639</span> <span class="comment"># Configuration loaded</span></span><br><span class="line">[root@huangkai conf]<span class="comment"># netstat -an|grep 6379</span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span><span class="symbol">:</span><span class="number">6379</span>            <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span><span class="symbol">:*</span>               LISTEN     </span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> <span class="symbol">:</span><span class="symbol">:</span><span class="symbol">:</span><span class="number">6379</span>                 <span class="symbol">:</span><span class="symbol">:</span><span class="symbol">:*</span>                    LISTEN     </span><br><span class="line">[root@huangkai conf]<span class="comment"># </span></span><br><span class="line"></span><br><span class="line">[root@huangkai ~]<span class="comment"># redis-cli -p 6379</span></span><br><span class="line"><span class="meta">127.0.0.1:6379&gt;</span> </span><br><span class="line"><span class="meta">127.0.0.1:6379&gt;</span></span><br></pre></td></tr></table></figure>
<p>启动 6380<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@huangkai conf]<span class="comment"># redis-server ./redis_6380.conf </span></span><br><span class="line">[root@huangkai conf]<span class="comment"># netstat -an|grep 6380</span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span><span class="symbol">:</span><span class="number">6380</span>            <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span><span class="symbol">:*</span>               LISTEN     </span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> <span class="symbol">:</span><span class="symbol">:</span><span class="symbol">:</span><span class="number">6380</span>                 <span class="symbol">:</span><span class="symbol">:</span><span class="symbol">:*</span>                    LISTEN     </span><br><span class="line">[root@huangkai conf]<span class="comment"># </span></span><br><span class="line"></span><br><span class="line">[root@huangkai ~]<span class="comment"># redis-cli -p 6380</span></span><br><span class="line"><span class="meta">127.0.0.1:6380&gt;</span> </span><br><span class="line"><span class="meta">127.0.0.1:6380&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>启动 6381<br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@huangkai conf]<span class="comment"># redis-server ./redis_6381.conf </span></span><br><span class="line">[root@huangkai conf]<span class="comment"># netstat -an|grep 6381          </span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span><span class="symbol">:</span><span class="number">6381</span>            <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span><span class="symbol">:*</span>               LISTEN     </span><br><span class="line">tcp6       <span class="number">0</span>      <span class="number">0</span> <span class="symbol">:</span><span class="symbol">:</span><span class="symbol">:</span><span class="number">6381</span>                 <span class="symbol">:</span><span class="symbol">:</span><span class="symbol">:*</span>                    LISTEN     </span><br><span class="line">[root@huangkai conf]<span class="comment">#</span></span><br><span class="line"></span><br><span class="line">[root@huangkai ~]<span class="comment"># redis-cli -p 6381</span></span><br><span class="line"><span class="meta">127.0.0.1:6381&gt;</span> </span><br><span class="line"><span class="meta">127.0.0.1:6381&gt;</span> </span><br><span class="line"><span class="string">``</span><span class="string">` </span></span><br><span class="line"><span class="string">现在，三台服务已启动，并且都成功连接上，使用 `</span><span class="string">`INFO REPLICATION`</span><span class="string">` 命令查看信息如下：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">6379：</span></span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6379&gt; INFO REPLICATION</p>
<h1 id="Replication"><a href="#Replication" class="headerlink" title="Replication"></a>Replication</h1><p>role:master<br>connected_slaves:0<br>master_replid:d7f13a179d3808311c9dc4467a7a68619d3bf5b8<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:0<br>second_repl_offset:-1<br>repl_backlog_active:0<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:0<br>repl_backlog_histlen:0<br>127.0.0.1:6379&gt;<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">6380</span>：</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6380&gt; INFO REPLICATION</p>
<h1 id="Replication-1"><a href="#Replication-1" class="headerlink" title="Replication"></a>Replication</h1><p>role:master<br>connected_slaves:0<br>master_replid:564db58a73b1dd19d262bd823bd590faaacec50e<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:0<br>second_repl_offset:-1<br>repl_backlog_active:0<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:0<br>repl_backlog_histlen:0<br>127.0.0.1:6380&gt;<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">6381</span>：</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6381&gt; INFO REPLICATION</p>
<h1 id="Replication-2"><a href="#Replication-2" class="headerlink" title="Replication"></a>Replication</h1><p>role:master<br>connected_slaves:0<br>master_replid:24a3159635d19972c822f86f024dc03fbad9c65d<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:0<br>second_repl_offset:-1<br>repl_backlog_active:0<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:0<br>repl_backlog_histlen:0<br>127.0.0.1:6381&gt;<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">从上面的信息可以看出，三台服务的 角色都 为 master，连接的 slaves为<span class="number">0</span>，也就是这三台服务现在还没有任何关系，在任意一台服务中设置值，其它两台都不会同步数据。</span><br><span class="line">如：在 <span class="number">6379</span> 设置 k1 为 k1 ，如下</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6379&gt; SET k1 k1<br>OK<br>127.0.0.1:6379&gt; get k1<br>“k1”<br>127.0.0.1:6379&gt;<br><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="symbol">6380 </span>获取k1的值，返回无结果，如下：</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6380&gt; get k1<br>(nil)<br>127.0.0.1:6380&gt;<br><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="symbol">6381 </span>获取k1的值，返回也无结果，如下：</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6381&gt; get k1<br>(nil)<br>127.0.0.1:6381&gt;<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">## <span class="number">4</span>、设置主从 ##</span><br><span class="line">### <span class="number">4.1</span>、最简单的主从配置 ###</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">现在将  <span class="number">6379</span>设置为master， <span class="number">6380</span> 与 <span class="number">6381</span> 设置为slave，配置如下：</span><br><span class="line"></span><br><span class="line"><span class="number">6380</span>：</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6380&gt; SLAVEOF 192.168.1.90 6379<br>OK<br>127.0.0.1:6380&gt;<br><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attribute">6381：</span></span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6381&gt; SLAVEOF 192.168.1.90 6379<br>OK<br>127.0.0.1:6381&gt;<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">查看各服务信息：</span><br><span class="line"></span><br><span class="line">6379：</span><br><span class="line">由下可知： 此服务角色为 <span class="selector-tag">master</span>，现在有两个连接的 <span class="selector-tag">slave</span>,分别为 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.90</span><span class="selector-pseudo">:6380</span> 与 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.90</span><span class="selector-pseudo">:6381</span>,并且都为在线状态。</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6379&gt; INFO REPLICATION</p>
<h1 id="Replication-3"><a href="#Replication-3" class="headerlink" title="Replication"></a>Replication</h1><p>role:master<br>connected_slaves:2<br>slave0:ip=192.168.1.90,port=6380,state=online,offset=112,lag=1<br>slave1:ip=192.168.1.90,port=6381,state=online,offset=112,lag=0<br>master_replid:7499fc3cfd327ecb9bf72c79e53cb5014f14230c<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:112<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:112<br>127.0.0.1:6379&gt;<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">6380</span>：</span><br><span class="line">由下可以，此时此服务的角色已变为 slave，它的master 主机为 <span class="number">192.168</span><span class="number">.1</span><span class="number">.90</span>，端口号为 <span class="number">6379</span>。</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6380&gt; INFO REPLICATION</p>
<h1 id="Replication-4"><a href="#Replication-4" class="headerlink" title="Replication"></a>Replication</h1><p>role:slave<br>master_host:192.168.1.90<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:6<br>master_sync_in_progress:0<br>slave_repl_offset:140<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:7499fc3cfd327ecb9bf72c79e53cb5014f14230c<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:140<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:140<br>127.0.0.1:6380&gt;<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">6381</span>：</span><br><span class="line">由下可以，此时此服务的角色也变为了 slave，它的master 主机为 <span class="number">192.168</span><span class="number">.1</span><span class="number">.90</span>，端口号为 <span class="number">6379</span>。</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6381&gt; INFO REPLICATION</p>
<h1 id="Replication-5"><a href="#Replication-5" class="headerlink" title="Replication"></a>Replication</h1><p>role:slave<br>master_host:192.168.1.90<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:1<br>master_sync_in_progress:0<br>slave_repl_offset:168<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:7499fc3cfd327ecb9bf72c79e53cb5014f14230c<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:168<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:15<br>repl_backlog_histlen:154<br>127.0.0.1:6381&gt;<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">之前在还没有配置slave时，我们在<span class="number">6379</span>服务中配置了 k1 值，此时主从复制配置成功后， <span class="number">6380</span>与 <span class="number">6381</span>是否会有 <span class="number">6379</span>中配置的值呢？</span><br><span class="line">使用命令查看一下：</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6380&gt; get k1<br>“k1”<br>127.0.0.1:6380&gt;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6381&gt; get k1<br>“k1”<br>127.0.0.1:6381&gt;<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">如上，可以看到 <span class="number">6380</span> 与 <span class="number">6381</span> 都能获取到值。</span><br><span class="line">**结论一：配置主从后，从服务器(slave)会复制主服务(master)的所有值。**</span><br><span class="line"></span><br><span class="line">### <span class="number">4.2</span>、从服务器设置值 ###</span><br><span class="line">现在，我们在slave服务器上设置值，看看会出现什么情况 ：</span><br><span class="line"></span><br><span class="line"><span class="number">6380</span>:</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6380&gt; set k2 k2<br>(error) READONLY You can’t write against a read only slave.<br>127.0.0.1:6380&gt;<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">6381</span>:</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6381&gt; set k3 v3<br>(error) READONLY You can’t write against a read only slave.<br>127.0.0.1:6381&gt;<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">如上，在从服务器上设置值，抛出了一个错误，意思是 <span class="literal">slave</span>只能读取数据，不能写数据。</span><br><span class="line">**结论二：配置主从后，所有的写操作都只能在主服务器(<span class="literal">master</span>)进行，从服务器(<span class="literal">slave</span>)只能读数据不能写数据。如果需要在从服务器中支持写功能，可以在需要写的<span class="literal">slave</span>执行命令 ``config set <span class="literal">slave</span>-<span class="keyword">read</span>-only no`` ，也就是使当前<span class="literal">slave</span>支持写功能。但是此种配置后，写入的数据只在当前<span class="literal">slave</span>中存在，不会同步其它的<span class="literal">slave</span>,更不会同步到<span class="literal">master</span>。 **</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 4.3、主服务器宕机 ###</span></span><br><span class="line"></span><br><span class="line">现在，我们将主服务器(<span class="literal">master</span>(<span class="number">6379</span>))停止服务，查看变化</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6379&gt; SHUTDOWN<br>not connected&gt;<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">查看 <span class="number">6380</span> 如下：</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6380&gt; info replication</p>
<h1 id="Replication-6"><a href="#Replication-6" class="headerlink" title="Replication"></a>Replication</h1><p>role:slave<br>master_host:192.168.184.128<br>master_port:6379<br>master_link_status:down<br>master_last_io_seconds_ago:-1<br>master_sync_in_progress:0<br>slave_repl_offset:854<br>master_link_down_since_seconds:26<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:ca0c52c31eefe3567c0beb099b83e174080e054e<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:854<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:854<br>127.0.0.1:6380&gt;<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">查看 <span class="number">6381</span> 如下：</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6381&gt; info replication</p>
<h1 id="Replication-7"><a href="#Replication-7" class="headerlink" title="Replication"></a>Replication</h1><p>role:slave<br>master_host:192.168.184.128<br>master_port:6379<br>master_link_status:down<br>master_last_io_seconds_ago:-1<br>master_sync_in_progress:0<br>slave_repl_offset:854<br>master_link_down_since_seconds:31<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:ca0c52c31eefe3567c0beb099b83e174080e054e<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:854<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:15<br>repl_backlog_histlen:840<br>127.0.0.1:6381&gt;<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">可以发现，slave并没有进行选举产生出master，现在它们的角色依然还是 slave。</span><br><span class="line"></span><br><span class="line">**结论三：当从服务器``SHUTDOWN``后，slave并没有通过选举产生新的master，此时会导致整个服务不可写。所以，在使用此种方式时，一定要将 master持久化，如果 master通过一个空数据集重启，slave中的数据也将被清空。**</span><br><span class="line"></span><br><span class="line">### <span class="number">4.4</span>、主服务器正常运行 ###</span><br><span class="line"></span><br><span class="line">现在启动 master，查看变化</span><br></pre></td></tr></table></figure></p>
<p>not connected&gt; quit<br>[root@huangkai ~]# cd /usr/local/redis-4.0.1/conf/<br>[root@huangkai conf]# redis-server ./redis.conf<br>2196:C 07 Nov 11:44:58.813 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo<br>2196:C 07 Nov 11:44:58.813 # Redis version=4.0.1, bits=64, commit=00000000, modified=0, pid=2196, just started<br>2196:C 07 Nov 11:44:58.813 # Configuration loaded<br>[root@huangkai conf]#<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">连接 <span class="number">6379</span>，查看信息如下：</span><br></pre></td></tr></table></figure></p>
<p>[root@huangkai conf]# redis-cli -p 6379<br>127.0.0.1:6379&gt; info replication</p>
<h1 id="Replication-8"><a href="#Replication-8" class="headerlink" title="Replication"></a>Replication</h1><p>role:master<br>connected_slaves:2<br>slave0:ip=127.0.0.1,port=6381,state=online,offset=910,lag=0<br>slave1:ip=127.0.0.1,port=6380,state=online,offset=910,lag=0<br>master_replid:3fe903a1fab24acafb159f837c6bb1b7e1d423a5<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:910<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:855<br>repl_backlog_histlen:56<br>127.0.0.1:6379&gt; set k2 v2<br>OK<br>127.0.0.1:6379&gt;<br><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="symbol">6380 </span>信息如下：</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6380&gt; info replication</p>
<h1 id="Replication-9"><a href="#Replication-9" class="headerlink" title="Replication"></a>Replication</h1><p>role:slave<br>master_host:192.168.184.128<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:5<br>master_sync_in_progress:0<br>slave_repl_offset:924<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:3fe903a1fab24acafb159f837c6bb1b7e1d423a5<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:924<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:855<br>repl_backlog_histlen:70<br>127.0.0.1:6380&gt; get k2<br>“v2”<br>127.0.0.1:6380&gt;</p>
<figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="symbol">6381 </span>信息如下：</span><br></pre></td></tr></table></figure>
<p>127.0.0.1:6381&gt; info replication</p>
<h1 id="Replication-10"><a href="#Replication-10" class="headerlink" title="Replication"></a>Replication</h1><p>role:slave<br>master_host:192.168.184.128<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:0<br>master_sync_in_progress:0<br>slave_repl_offset:938<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:3fe903a1fab24acafb159f837c6bb1b7e1d423a5<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:938<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:855<br>repl_backlog_histlen:84<br>127.0.0.1:6381&gt; get k2<br>“v2”<br>127.0.0.1:6381&gt;<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">通过以上信息可知，当 <span class="keyword">master</span> <span class="title">重新恢复后，整个服务都可正常使用。</span></span><br><span class="line"><span class="title"></span></span><br><span class="line"><span class="title"></span></span><br><span class="line"><span class="title">### 4</span>.<span class="number">5</span>、既主既从 <span class="comment">###</span></span><br><span class="line"></span><br><span class="line">现在将 <span class="number">6380</span> 设置为 <span class="number">6379</span>的 <span class="literal">slave</span> ，并且设置为 <span class="number">6381</span>的 <span class="literal">master</span></span><br><span class="line"></span><br><span class="line"><span class="number">6379</span> 不需要修改配置</span><br><span class="line"></span><br><span class="line">将<span class="number">6380</span>设置为<span class="number">6379</span>的<span class="literal">slave</span>如下：</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6380&gt; SLAVEOF 162.168.184.128 6379<br>OK<br>127.0.0.1:6380&gt;<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">将<span class="number">6381</span>设置为<span class="number">6380</span>的 slave 如下：</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6381&gt; SLAVEOF 162.168.184.128 6380<br>OK<br>127.0.0.1:6381&gt;<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">查看 <span class="number">6379</span>信息如下：</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6379&gt; info replication</p>
<h1 id="Replication-11"><a href="#Replication-11" class="headerlink" title="Replication"></a>Replication</h1><p>role:master<br>connected_slaves:1<br>slave0:ip=127.0.0.1,port=6380,state=online,offset=9180,lag=1<br>master_replid:3fe903a1fab24acafb159f837c6bb1b7e1d423a5<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:9180<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:855<br>repl_backlog_histlen:8326<br>127.0.0.1:6379&gt;<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">查看 <span class="number">6380</span>信息如下：</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6380&gt; info replication</p>
<h1 id="Replication-12"><a href="#Replication-12" class="headerlink" title="Replication"></a>Replication</h1><p>role:slave<br>master_host:192.168.184.128<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:9<br>master_sync_in_progress:0<br>slave_repl_offset:9180<br>slave_priority:100<br>slave_read_only:0<br>connected_slaves:0<br>master_replid:3fe903a1fab24acafb159f837c6bb1b7e1d423a5<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:9180<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:855<br>repl_backlog_histlen:8326<br>127.0.0.1:6380&gt;<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">查看 <span class="number">6381</span> 信息如下：</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6381&gt; info replication</p>
<h1 id="Replication-13"><a href="#Replication-13" class="headerlink" title="Replication"></a>Replication</h1><p>role:slave<br>master_host:162.168.184.128<br>master_port:6380<br>master_link_status:up<br>master_last_io_seconds_ago:-1<br>master_sync_in_progress:0<br>slave_repl_offset:9166<br>master_link_down_since_seconds:1510032310<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:3fe903a1fab24acafb159f837c6bb1b7e1d423a5<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:9166<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:855<br>repl_backlog_histlen:8312<br>127.0.0.1:6381&gt;<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">通过以上可知 ：</span><br><span class="line"><span class="number">6379</span> 角色为 <span class="literal">master</span>，<span class="literal">slave</span> 只有一个，为 <span class="number">6380</span></span><br><span class="line"><span class="number">6380</span> 角色为 <span class="literal">slave</span>，<span class="keyword">master</span> <span class="title">为 6379</span></span><br><span class="line"><span class="number">6380</span> 角色为 <span class="literal">slave</span>，<span class="keyword">master</span> <span class="title">为 6380</span></span><br><span class="line"></span><br><span class="line"><span class="number">6379</span> 设置值 ：</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6379&gt; set k3 v3<br>OK<br>127.0.0.1:6379&gt;<br><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="symbol">6380 </span>获取值 ：</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6380&gt; get k3<br>“v3”<br>127.0.0.1:6380&gt;<br><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="symbol">6381 </span>获取值 ：</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6381&gt; get k3<br>“v3”<br>127.0.0.1:6381&gt;<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">由上可知，此种方式配置，也会同步 <span class="number">6381</span> 服务的数据。</span><br><span class="line"></span><br><span class="line">### <span class="number">4.6</span>、反从为主 ###</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### <span class="number">4.7</span>、redis哨兵模式(sentinel) ###</span><br><span class="line"></span><br><span class="line">Redis 的 Sentinel 用于管理多个 Redis 服务器（<span class="keyword">instance</span>）， 该系统执行以下三个任务：</span><br><span class="line">- 监控（Monitoring）： Sentinel 会不断地检查你的主服务器和从服务器是否运作正常。</span><br><span class="line">- 提醒（Notification）： 当被监控的某个 Redis 服务器出现问题时， Sentinel 可以通过 API 向管理员或者其他应用程序发送通知。</span><br><span class="line">- 自动故障迁移（Automatic failover）： 当一个主服务器不能正常工作时， Sentinel 会开始一次自动故障迁移操作， 它会将失效主服务器的其中一个从服务器升级为新的主服务器， 并让失效主服务器的其他从服务器改为复制新的主服务器； 当客户端试图连接失效的主服务器时， 集群也会向客户端返回新主服务器的地址， 使得集群可以使用新主服务器代替失效服务器。</span><br><span class="line"></span><br><span class="line">可以这样说，Redis的sentinel就是 [反从为主](#<span class="number">4.6</span>-)的自动档。</span><br><span class="line"></span><br><span class="line">#### <span class="number">4.7</span><span class="number">.1</span>、sentinel 配置文件： ####</span><br><span class="line"></span><br><span class="line">安装完redis后，在redis根目录下，会有sentinel.conf 配置文件，该配置文件参数如下：</span><br></pre></td></tr></table></figure></p>
<p>#配置sentinel端口号，默认为 26379</p>
<h2 id="port-26379"><a href="#port-26379" class="headerlink" title="port 26379 "></a>port 26379 </h2><p>#sentinel目录</p>
<h2 id="dir-tmp"><a href="#dir-tmp" class="headerlink" title="dir /tmp"></a>dir /tmp</h2><h1 id="告诉sentinel去监听地址为ip-port的一个master，这里的master-name可以自定义，quorum是一个数字，"><a href="#告诉sentinel去监听地址为ip-port的一个master，这里的master-name可以自定义，quorum是一个数字，" class="headerlink" title="告诉sentinel去监听地址为ip:port的一个master，这里的master-name可以自定义，quorum是一个数字，"></a>告诉sentinel去监听地址为ip:port的一个master，这里的master-name可以自定义，quorum是一个数字，</h1><p>#指明当有多少个sentinel认为一个master失效时，master才算真正失效。</p>
<p>#master-name只能包含英文字母，数字和“.-_”这三种字符,需要注意的是master-ip 要写真实的ip地址而不要用回环地址（127.0.0.1）</p>
<p>#配置示例：sentinel monitor mymaster 192.168.0.5 6379 1</p>
<h2 id="sentinel-monitor"><a href="#sentinel-monitor" class="headerlink" title="sentinel monitor    "></a>sentinel monitor <master-name> <ip> <redis-port> <quorum></quorum></redis-port></ip></master-name></h2><p>#设置连接master和slave时的密码，注意的是sentinel不能分别为master和slave设置不同的密码，因此master和slave的密码应该设置相同。<br>配置示例：sentinel auth-pass mymaster 0123passw0rd</p>
<h2 id="sentinel-auth-pass"><a href="#sentinel-auth-pass" class="headerlink" title="sentinel auth-pass  "></a>sentinel auth-pass <master-name> <password></password></master-name></h2><p>#指定需要多少失效时间，一个master才会被这个sentinel主观地认为是不可用的。 单位是毫秒，默认为30秒</p>
<p>#配置示例： sentinel down-after-milliseconds mymaster 30000</p>
<h2 id="sentinel-down-after-milliseconds"><a href="#sentinel-down-after-milliseconds" class="headerlink" title="sentinel down-after-milliseconds   "></a>sentinel down-after-milliseconds <master-name> <milliseconds> </milliseconds></master-name></h2><p>#指定在发生failover(主备切换时)最多可以有多少个slave同时对新的master进行同步，这个数字越小，完成failover所需的时间就越长，但是如果这个数字越大，就意味着越多的slave因为replication而不可用。可以通过将这个值设为 1 来保证每次只有一个slave 处于不能处理命令请求的状态。</p>
<p>#配置示例： sentinel parallel-syncs mymaster 1</p>
<h2 id="sentinel-parallel-syncs"><a href="#sentinel-parallel-syncs" class="headerlink" title="sentinel parallel-syncs   "></a>sentinel parallel-syncs <master-name> <numslaves> </numslaves></master-name></h2><p>#failover-timeout 可以用在以下这些方面：</p>
<ol>
<li>同一个sentinel对同一个master两次failover之间的间隔时间。</li>
<li>当一个slave从一个错误的master那里同步数据开始计算时间。直到slave被纠正为向正确的master那里同步数据时。</li>
<li>当想要取消一个正在进行的failover所需要的时间。  </li>
<li>当进行failover时，配置所有slaves指向新的master所需的最大时间。不过，即使过了这个超时，slaves依然会被正确配置为指向master，但是就不按parallel-syncs所配置的规则来了。<br>配置示例：sentinel failover-timeout mymaster1 20000<br>sentinel failover-timeout <master-name> <milliseconds></milliseconds></master-name></li>
</ol>
<hr>
<p>sentinel的notification-script和reconfig-script是用来配置当某一事件发生时所需要执行的脚本，可以通过脚本来通知管理员，例如当系统运行不正常时发邮件通知相关人员。对于脚本的运行结果有以下规则：<br>1.若脚本执行后返回1，那么该脚本稍后将会被再次执行，重复次数目前默认为10<br>2.若脚本执行后返回2，或者比2更高的一个返回值，脚本将不会重复执行。<br>如果脚本在执行过程中由于收到系统中断信号被终止了，则同返回值为1时的行为相同。<br>一个脚本的最大执行时间为60s，如果超过这个时间，脚本将会被一个SIGKILL信号终止，之后重新执行。</p>
<p>sentinel notification-script <master-name> <script-path><br>通知型脚本:当sentinel有任何警告级别的事件发生时（比如说redis实例的主观失效和客观失效等等），将会去调用这个脚本，这时这个脚本应该通过邮件，SMS等方式去通知系统管理员关于系统不正常运行的信息。调用该脚本时，将传给脚本两个参数，一个是事件的类型，一个是事件的描述。如果sentinel.conf配置文件中配置了这个脚本路径，那么必须保证这个脚本存在于这个路径，并且是可执行的，否则sentinel无法正常启动成功。<br>配置示例：sentinel notification-script mymaster /var/redis/notify.sh</script-path></master-name></p>
<p>sentinel client-reconfig-script <master-name> <script-path><br>当一个master由于failover而发生改变时，这个脚本将会被调用，通知相关的客户端关于master地址已经发生改变的信息。以下参数将会在调用脚本时传给脚本:</script-path></master-name></p>
<p><master-name> <role> <state> <from-ip> <from-port> <to-ip> <to-port><br>目前<state>总是“failover”, <role>是“leader”或者“observer”中的一个。 参数 from-ip, from-port, to-ip, to-port是用来和旧的master和新的master(即旧的slave)通信的。这个脚本应该是通用的，能被多次调用，不是针对性的。<br>配置示例：sentinel client-reconfig-script mymaster /var/redis/reconfig.sh<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#### 4<span class="selector-class">.7</span><span class="selector-class">.2</span>、一主双从三<span class="selector-tag">sentinel</span> ####</span><br><span class="line">通过配置一主双从三<span class="selector-tag">sentinel</span>实现<span class="selector-tag">redis</span> 监控与自动故障迁移。</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">ip</span>地址分配如下:</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">master</span><span class="selector-pseudo">:192.168.1.90</span> 6379</span><br><span class="line"><span class="selector-tag">slave1</span><span class="selector-pseudo">:192.168.1.90</span> 6380</span><br><span class="line"><span class="selector-tag">slave2</span><span class="selector-pseudo">:192.168.1.90</span> 6381</span><br><span class="line"><span class="selector-tag">sentinel1</span> : 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.90</span> 26379</span><br><span class="line"><span class="selector-tag">sentinel2</span> : 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.90</span> 26389</span><br><span class="line"><span class="selector-tag">sentinel3</span> : 192<span class="selector-class">.168</span><span class="selector-class">.1</span><span class="selector-class">.90</span> 26399</span><br><span class="line"></span><br><span class="line">一主三从配置见 <span class="selector-attr">[修改配置文件]</span>(<span class="selector-id">#2-</span>)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">sentinel</span>配置如下：</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">sentinel1</span>:</span><br></pre></td></tr></table></figure></role></state></to-port></to-ip></from-port></from-ip></state></role></master-name></p>
<p>#将配置文件复制到conf目录，保留出厂配置<br>[root@huangkai redis-4.0.1]#cp sentinel.conf conf/</p>
<p>#修改配置文件，内容如下</p>
<p>port 26379 #端口号，<br>daemonize yes # 是否以守护进程启动，默认此文件中没有此配置，默认值为 no，如果不添加，启动sentinel时，进程会直接在前台跑，一退出sentinel进程就关了，还一种方式是以 nohub 来启动<br>logfile “/var/log/sentinel_26379.log”  #日志文件<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="symbol">sentinel2:</span></span><br></pre></td></tr></table></figure></p>
<p>[root@huangkai conf]# cp sentinel.conf sentinel_26389.conf<br>[root@huangkai conf]# </p>
<p>#修改配置文件，内容如下<br>port 26389 #端口号，<br>daemonize yes<br>logfile “/var/log/sentinel_26389.log”<br><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="symbol">sentinel3:</span></span><br></pre></td></tr></table></figure></p>
<p>[root@huangkai conf]# cp sentinel.conf sentinel_26399.conf<br>[root@huangkai conf]# </p>
<p>#修改配置文件，内容如下<br>port 26399 #端口号，<br>daemonize yes<br>logfile “/var/log/sentinel_26399.log”<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">启动 se<span class="symbol">ntinel1</span></span><br></pre></td></tr></table></figure></p>
<p>[root@huangkai conf]# redis-sentinel ./sentinel.conf<br>[root@huangkai conf]# </p>
<p>#连接<br>[root@huangkai ~]# redis-cli -p 26379<br>127.0.0.1:26379&gt; sentinel master mymaster<br> 1) “name”<br> 2) “mymaster”<br> 3) “ip”<br> 4) “127.0.0.1”<br> 5) “port”<br> 6) “6379”<br> 7) “runid”<br> 8) “334ab6dba2c2e236929d925fc21298649736bcae”<br> 9) “flags”<br>10) “master”<br>11) “link-pending-commands”<br>12) “0”<br>13) “link-refcount”<br>14) “1”<br>15) “last-ping-sent”<br>16) “0”<br>17) “last-ok-ping-reply”<br>18) “876”<br>19) “last-ping-reply”<br>20) “876”<br>21) “down-after-milliseconds”<br>22) “30000”<br>23) “info-refresh”<br>24) “1992”<br>25) “role-reported”<br>26) “master”<br>27) “role-reported-time”<br>28) “674576”<br>29) “config-epoch”<br>30) “0”<br>31) “num-slaves”<br>32) “2”<br>33) “num-other-sentinels”<br>34) “0”<br>35) “quorum”<br>36) “2”<br>37) “failover-timeout”<br>38) “180000”<br>39) “parallel-syncs”<br>40) “1”<br>127.0.0.1:26379&gt;<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">启动 se<span class="symbol">ntinel2</span></span><br></pre></td></tr></table></figure></p>
<p>[root@huangkai conf]# redis-sentinel ./sentinel_26389.conf </p>
<p>#连接<br>[root@huangkai ~]# redis-cli -p 26389<br>127.0.0.1:26389&gt; sentinel master mymaster<br> 1) “name”<br> 2) “mymaster”<br> 3) “ip”<br> 4) “127.0.0.1”<br> 5) “port”<br> 6) “6379”<br> 7) “runid”<br> 8) “334ab6dba2c2e236929d925fc21298649736bcae”<br> 9) “flags”<br>10) “master”<br>11) “link-pending-commands”<br>12) “0”<br>13) “link-refcount”<br>14) “1”<br>15) “last-ping-sent”<br>16) “0”<br>17) “last-ok-ping-reply”<br>18) “122”<br>19) “last-ping-reply”<br>20) “122”<br>21) “down-after-milliseconds”<br>22) “30000”<br>23) “info-refresh”<br>24) “1972”<br>25) “role-reported”<br>26) “master”<br>27) “role-reported-time”<br>28) “122532”<br>29) “config-epoch”<br>30) “0”<br>31) “num-slaves”<br>32) “2”<br>33) “num-other-sentinels”<br>34) “0”<br>35) “quorum”<br>36) “2”<br>37) “failover-timeout”<br>38) “180000”<br>39) “parallel-syncs”<br>40) “1”<br>127.0.0.1:26389&gt;<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">启动 se<span class="symbol">ntinel3</span></span><br></pre></td></tr></table></figure></p>
<p>[root@huangkai conf]# redis-sentinel ./sentinel_26399.conf </p>
<p>#连接<br>[root@huangkai ~]# redis-cli -p 26399<br>127.0.0.1:26399&gt; sentinel master mymaster<br> 1) “name”<br> 2) “mymaster”<br> 3) “ip”<br> 4) “127.0.0.1”<br> 5) “port”<br> 6) “6379”<br> 7) “runid”<br> 8) “334ab6dba2c2e236929d925fc21298649736bcae”<br> 9) “flags”<br>10) “master”<br>11) “link-pending-commands”<br>12) “0”<br>13) “link-refcount”<br>14) “1”<br>15) “last-ping-sent”<br>16) “0”<br>17) “last-ok-ping-reply”<br>18) “442”<br>19) “last-ping-reply”<br>20) “442”<br>21) “down-after-milliseconds”<br>22) “30000”<br>23) “info-refresh”<br>24) “9464”<br>25) “role-reported”<br>26) “master”<br>27) “role-reported-time”<br>28) “119978”<br>29) “config-epoch”<br>30) “0”<br>31) “num-slaves”<br>32) “2”<br>33) “num-other-sentinels”<br>34) “0”<br>35) “quorum”<br>36) “2”<br>37) “failover-timeout”<br>38) “180000”<br>39) “parallel-syncs”<br>40) “1”<br>127.0.0.1:26399&gt;<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">到此，一主双从三sentinel配置完成。</span><br><span class="line"></span><br><span class="line">停止 <span class="number">6379</span>(<span class="literal">master</span>)，查看变化:</span><br></pre></td></tr></table></figure></p>
<p>127.0.0.1:6379&gt; info replication</p>
<h1 id="Replication-14"><a href="#Replication-14" class="headerlink" title="Replication"></a>Replication</h1><p>role:master<br>connected_slaves:2<br>slave0:ip=127.0.0.1,port=6381,state=online,offset=133321,lag=1<br>slave1:ip=127.0.0.1,port=6380,state=online,offset=133454,lag=1<br>master_replid:3fe903a1fab24acafb159f837c6bb1b7e1d423a5<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:133587<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:855<br>repl_backlog_histlen:132733<br>127.0.0.1:6379&gt; SHUTDOWN<br>not connected&gt;<br><code>`</code></p>
<p>主从复制的缺点：<br>由于所有的写操作都是在master上进行，然后同步到slave，master复制到 slave会有一定的延时，当系统繁忙时，可能延时会更加严重，slave机器增多也会使这个问题更严重。 </p>
</div><div class="tags"><a href="/tags/Redis/">Redis</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2018/07/09/Browsersync/" class="pre">browsersync(浏览器同步工具)</a><a href="/2018/07/09/10_其它改进/" class="next">其它改进</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、-创建配置文件"><span class="toc-text">1、 创建配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、修改配置文件"><span class="toc-text">2、修改配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、启动三台Redis服务"><span class="toc-text">3、启动三台Redis服务</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Replication"><span class="toc-text">Replication</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Replication-1"><span class="toc-text">Replication</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Replication-2"><span class="toc-text">Replication</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Replication-3"><span class="toc-text">Replication</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Replication-4"><span class="toc-text">Replication</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Replication-5"><span class="toc-text">Replication</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Replication-6"><span class="toc-text">Replication</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Replication-7"><span class="toc-text">Replication</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Replication-8"><span class="toc-text">Replication</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Replication-9"><span class="toc-text">Replication</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Replication-10"><span class="toc-text">Replication</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Replication-11"><span class="toc-text">Replication</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Replication-12"><span class="toc-text">Replication</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Replication-13"><span class="toc-text">Replication</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#port-26379"><span class="toc-text">port 26379 </span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dir-tmp"><span class="toc-text">dir /tmp</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#告诉sentinel去监听地址为ip-port的一个master，这里的master-name可以自定义，quorum是一个数字，"><span class="toc-text">告诉sentinel去监听地址为ip:port的一个master，这里的master-name可以自定义，quorum是一个数字，</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#sentinel-monitor"><span class="toc-text">sentinel monitor    </span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sentinel-auth-pass"><span class="toc-text">sentinel auth-pass  </span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sentinel-down-after-milliseconds"><span class="toc-text">sentinel down-after-milliseconds   </span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sentinel-parallel-syncs"><span class="toc-text">sentinel parallel-syncs   </span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Replication-14"><span class="toc-text">Replication</span></a></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/07/09/vue_01/">Vue 简介</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/09/Browsersync/">browsersync(浏览器同步工具)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/09/Redis_06_主从复制(哨兵机制)/">Redis 主从复制</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/09/10_其它改进/">其它改进</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/09/09_http改进/">全新的HTTP API</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/09/08_Stream改进/">API改进_Stream API</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/09/07_集合改进/">API改进_集合</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/09/06_标识符&String/">语法改进_标识符&String</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/09/05_异常处理/">语法改进_try</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/09/04_钻石操作符/">语法改进_钻石操作符(泛型 [Diamond operator])</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/ETL/" style="font-size: 15px;">ETL</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/JPA/" style="font-size: 15px;">JPA</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Mac/" style="font-size: 15px;">Mac</a> <a href="/tags/MySql/" style="font-size: 15px;">MySql</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Idea/" style="font-size: 15px;">Idea</a> <a href="/tags/Tool/" style="font-size: 15px;">Tool</a> <a href="/tags/Spring-Cloud/" style="font-size: 15px;">Spring Cloud</a> <a href="/tags/Spring-Boot/" style="font-size: 15px;">Spring-Boot</a> <a href="/tags/Svn/" style="font-size: 15px;">Svn</a> <a href="/tags/Thymeleaf/" style="font-size: 15px;">Thymeleaf</a> <a href="/tags/Hadoop/" style="font-size: 15px;">Hadoop</a> <a href="/tags/JDK9/" style="font-size: 15px;">JDK9</a> <a href="/tags/Vue/" style="font-size: 15px;">Vue</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">Huangkai.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script></body></html>