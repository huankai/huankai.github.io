<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Huangkai,huankai"><title>GitLab 搭建及配置 | HuangkaiのBlog</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">GitLab 搭建及配置</h1><a id="logo" href="/.">HuangkaiのBlog</a><p class="description">学而不思则罔 思而不学则殆</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Arama"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">GitLab 搭建及配置</h1><div class="post-meta"><a href="/2018/07/09/Git_04_GitLab/#comments" class="comment-count"></a><p><span class="date">Jul 09, 2018</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h1 id="一、GitLab-简介"><a href="#一、GitLab-简介" class="headerlink" title="一、GitLab 简介"></a>一、GitLab 简介</h1><p>GitLab 是一个利用Ruby on Rails 开发的开源版本控制系统，实现一个自托管的Git项目仓库，可通过Web界面进行访问公开的或者私人项目。</p>
<p>它拥有与GitHub类似的功能，能够浏览源代码，管理缺陷和注释。可以管理团队对仓库的访问，它非常易于浏览提交过的版本并提供一个文件历史库。团队成员可以利用内置的简单聊天程序（Wall）进行交流。它还提供一个代码片段收集功能可以轻松实现代码复用，便于日后有需要的时候进行查找。</p>
<p>开源中国代码托管平台 码云 就是基于GitLab项目搭建。</p>
<p>GitLab 分为 GitLab Community Edition(CE) 社区版 和 GitLab Enterprise Edition(EE) 专业版。社区版免费，专业版收费，两个版本在功能上的差异对比，可以参考官方<a href="https://about.gitlab.com/features/#compare" target="_blank" rel="noopener">对比说明</a></p>
<h1 id="二、GitLab-安装和配置"><a href="#二、GitLab-安装和配置" class="headerlink" title="二、GitLab 安装和配置"></a>二、GitLab 安装和配置</h1><p>安装社区版，GitLab CE 版本：10.8.1这此省略</p>
<h2 id="2-1、GitLab安装"><a href="#2-1、GitLab安装" class="headerlink" title="2.1、GitLab安装"></a>2.1、GitLab安装</h2><p><strong>安装要求</strong></p>
<ul>
<li>操作系统：windows 暂不支持，不受支持的 Unix衍生版有：Arch Linux、Fedora、FreeBSD、Gentoo、macOS</li>
<li>内存: 必须不少于 4GB，否则在安装过程中会出现不可预知的问题，这也是官网的推荐。</li>
<li>Ruby版本：2.3以上。</li>
<li>CPU： 2核心，可支持500用户，这也是官网的推荐</li>
<li>数据库： PostgreSQL (官网推荐) 、MySQL/MariaDB (有些功能会受限)</li>
<li>更多要求，请查看<a href="https://docs.gitlab.com.cn/ce/install/requirements.html" target="_blank" rel="noopener">官网文档</a></li>
</ul>
<p>通过GitLab官方提供的Omnibus安装包来安装，相对方便。Omnibus安装包套件整合了大部分的套件（Nginx、ruby on rails、git、redis、postgresql等），再不用额外安装这些软件，减轻了绝大部分安装量。</p>
<p>GitLab官方安装文档 ：<a href="https://www.gitlab.com.cn/installation/#centos-7" target="_blank" rel="noopener">CentOS7.x系统</a></p>
<p><strong>安装依赖包，并配置postfix服务为GitLab邮件服务</strong><br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@sjq</span><span class="number">-09</span> ~]<span class="meta"># yum install curl openssh-server openssh-clients postfix cronie</span></span><br><span class="line">[root<span class="symbol">@sjq</span><span class="number">-09</span> ~]<span class="meta"># systemctl start postfix	</span></span><br><span class="line">[root<span class="symbol">@sjq</span><span class="number">-09</span> ~]<span class="meta"># systemctl enable postfix  # 配置开机启动</span></span><br><span class="line"><span class="meta"># 关闭防火墙</span></span><br><span class="line">[root<span class="symbol">@sjq</span><span class="number">-09</span> ~]<span class="meta"># systemctl stop firewalld</span></span><br></pre></td></tr></table></figure></p>
<p><strong>两种安装源：</strong></p>
<ul>
<li><p>从官方镜像源安装<br>添加GitLab仓库并安装到服务器上</p>
  <figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@sjq</span><span class="number">-09</span> ~]<span class="meta"># curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.rpm.sh | sudo bash</span></span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@sjq</span><span class="number">-09</span> ~]<span class="meta"># yum install gitlab-ce    # 自动安装最新版本</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>从第三方镜像源安装<br>官方镜像源在国外，国外安装会很慢，甚至有时因网络问题会无法安装。<br>国内推荐使用 <a href="https://mirror.tuna.tsinghua.edu.cn/help/gitlab-ce/" target="_blank" rel="noopener">清华大学开源软件镜像源</a>。<br>使用 <code>vim /etc/yum.repos.d/gitlab-ce.repo</code>创建文件，内容如下：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[gitlab-ce]</span></span><br><span class="line"><span class="attr">name</span>=Gitlab CE Repository</span><br><span class="line"><span class="attr">baseurl</span>=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el<span class="variable">$releasever</span>/</span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">enabled</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>保存、退出vim 后，再执行：<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@sjq</span><span class="number">-09</span> ~]<span class="meta"># yum makecache   # 更新本地YUM缓存</span></span><br><span class="line">[root<span class="symbol">@sjq</span><span class="number">-09</span> ~]<span class="meta"># yum install gitlab-ce    # 自动安装最新版本</span></span><br></pre></td></tr></table></figure></p>
<p>修改配置文件<code>vim /etc/gitlab/gitlab.rb</code>，绑定域名<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">external_url</span> <span class="string">'http://xxx.com'</span> <span class="comment">#也可以写ip地址</span></span><br></pre></td></tr></table></figure></p>
<p>启动GitLab，使得配置生效<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@sjq</span><span class="number">-09</span> ~]<span class="meta"># gitlab-ctl reconfigure</span></span><br></pre></td></tr></table></figure></p>
<p><strong>使用浏览器访问GitLab</strong><br>首次访问GitLab,系统会让你重新设置管理员的密码,设置成功后会返回登录界面。<br>默认的管理员账号是root,如果你想更改默认管理员账号,请输入上面设置的新密码登录系统后修改帐号名.</p>
<p><strong>GitLab相关目录及配置</strong></p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">主配置文件: <span class="regexp">/etc/gitlab</span><span class="regexp">/gitlab.rb</span></span><br><span class="line"><span class="regexp">GitLab 文档根目录: /opt</span><span class="regexp">/gitlab</span></span><br><span class="line"><span class="regexp">默认存储库位置: /var</span><span class="regexp">/opt/gitlab</span><span class="regexp">/git-data/repositories</span></span><br><span class="line">GitLab Nginx 配置文件路径:  <span class="regexp">/var/opt</span><span class="regexp">/gitlab/nginx</span><span class="regexp">/conf/gitlab</span>-http.conf</span><br><span class="line">Postgresql 数据目录: <span class="regexp">/var/opt</span><span class="regexp">/gitlab/postgresql</span><span class="regexp">/data</span></span><br></pre></td></tr></table></figure>
<p><strong>GitLab由以下服务构成</strong></p>
<ul>
<li>nginx: 静态web服务器</li>
<li>gitlab-shell: 用于处理Git命令和修改authorized keys列表</li>
<li>gitlab-workhorse: 轻量级的反向代理服务器</li>
<li>logrotate：日志文件管理工具</li>
<li>postgresql：数据库、</li>
<li>redis：缓存数据库</li>
<li>sidekiq：用于在后台执行队列任务（异步执行）</li>
<li>unicorn：An HTTP server for Rack applications，GitLab Rails应用是托管在这个服务器上面的。</li>
</ul>
<h2 id="2-2、配置："><a href="#2-2、配置：" class="headerlink" title="2.2、配置："></a>2.2、配置：</h2><p><strong>2.2.1、配置SMTP服务</strong><br>如果你不想用服务器自带的postfix服务来发邮件，可以改用SMTP服务。<br>修改GitLab邮件服务配置(gitlab.rb文件)，使用腾讯企业邮箱的SMTP服务器，填写账号和密码：<br><code>vim /etc/gitlab/gitlab.rb</code><br><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gitlab_rails[<span class="string">'smtp_address'</span>] = <span class="string">"smtp.exmail.qq.com"</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_port'</span>] = <span class="number">25</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_user_name'</span>] = <span class="string">"xxx"</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_password'</span>] = <span class="string">"xxx"</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_domain'</span>] = <span class="string">"smtp.qq.com"</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_authentication'</span>] = <span class="string">'plain'</span></span><br><span class="line">gitlab_rails[<span class="string">'smtp_enable_starttls_auto'</span>] = true</span><br></pre></td></tr></table></figure></p>
<p>使配置生效:<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@sjq</span><span class="number">-09</span> ~]<span class="meta"># gitlab-ctl reconfigure</span></span><br><span class="line">[root<span class="symbol">@sjq</span><span class="number">-09</span> ~]<span class="meta"># gitlab-rake cache:clear RAILS_ENV=production      # 清除缓存</span></span><br></pre></td></tr></table></figure></p>
<p><strong>2.2.2、GitLab配置HTTPS</strong><br>GitLab默认是使用HTTP的，可以手动配置为HTTPS<br>上传SSL证书，创建 SSL目录，用于存放SSL证书<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@sjq</span><span class="number">-09</span> ~]<span class="meta"># mkdir -p /etc/gitlab/ssl</span></span><br><span class="line">[root<span class="symbol">@sjq</span><span class="number">-09</span> ~]<span class="meta"># chmod 0700 /etc/gitlab/ssl</span></span><br></pre></td></tr></table></figure></p>
<p>上传证书并修改证书权限<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@sjq</span><span class="number">-09</span> ~]<span class="meta"># chmod 600 /etc/gitlab/ssl/*</span></span><br></pre></td></tr></table></figure></p>
<p>修改GitLab的主配置文件<br><code>vim /etc/gitlab/gitlab.rb</code></p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">external_url <span class="string">"https://xxx.com"</span></span><br><span class="line">nginx[<span class="string">'redirect_http_to_https'</span>] = true</span><br><span class="line">nginx[<span class="string">'ssl_certificate'</span>] = <span class="string">"/etc/gitlab/ssl/xxx.com.crt"</span></span><br><span class="line">nginx[<span class="string">'ssl_certificate_key'</span>] = <span class="string">"/etc/gitlab/ssl/xxx.com.key"</span></span><br></pre></td></tr></table></figure>
<p>重建配置，使其生效<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@sjq</span><span class="number">-09</span> ~]<span class="meta"># gitlab-ctl reconfigure</span></span><br></pre></td></tr></table></figure></p>
<p>以上操作后，GitLab自带的Nginx服务的配置文件 /var/opt/gitlab/nginx/conf/gitlab-http.conf 会被重新修改：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> *:<span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span> xxx.com;</span><br><span class="line">  <span class="attribute">server_tokens</span> <span class="literal">off</span>; <span class="comment">## Don't show the nginx version number, a security best practice</span></span><br><span class="line">  <span class="attribute">return</span> <span class="number">301</span> https://xxx.com:443<span class="variable">$request_uri</span>;</span><br><span class="line">  <span class="attribute">access_log</span>  /var/log/gitlab/nginx/gitlab_access.log gitlab_access;</span><br><span class="line">  <span class="attribute">error_log</span>   /var/log/gitlab/nginx/gitlab_error.log;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不用额外再配置，HTTP 会自动跳转到 HTTPS 。<br>开放443端口，因为防火墙未开启，此处省略。</p>
<h2 id="三、gitLab服务管理"><a href="#三、gitLab服务管理" class="headerlink" title="三、gitLab服务管理"></a>三、gitLab服务管理</h2><h3 id="3-1、服务管理"><a href="#3-1、服务管理" class="headerlink" title="3.1、服务管理"></a>3.1、服务管理</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 启动所有 gitlab 组件：</span></span><br><span class="line">gitlab-ctl start</span><br><span class="line"><span class="meta">#</span><span class="bash"> 停止所有 gitlab 组件：</span></span><br><span class="line">gitlab-ctl stop</span><br><span class="line"><span class="meta">#</span><span class="bash"> 停止所有 gitlab postgresql 组件：</span></span><br><span class="line">gitlab-ctl stop postgresql</span><br><span class="line"><span class="meta">#</span><span class="bash"> 停止相关数据连接服务</span></span><br><span class="line">gitlab-ctl stop unicorn</span><br><span class="line">gitlab-ctl stop sidekiq</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启所有 gitlab 组件：</span></span><br><span class="line">gitlab-ctl restart</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启所有 gitlab gitlab-workhorse 组件：</span></span><br><span class="line">gitlab-ctl restart  gitlab-workhorse</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看服务状态</span></span><br><span class="line">gitlab-ctl status</span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成配置并启动服务</span></span><br><span class="line">gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure>
<h3 id="3-2、日志管理"><a href="#3-2、日志管理" class="headerlink" title="3.2、日志管理"></a>3.2、日志管理</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 实时查看所有日志</span></span><br><span class="line">gitlab-ctl tail</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 实时检查redis的日志</span></span><br><span class="line">gitlab-ctl tail redis</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 实时检查postgresql的日志</span></span><br><span class="line">gitlab-ctl tail postgresql</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查gitlab-workhorse的日志</span></span><br><span class="line">gitlab-ctl tail gitlab-workhorse</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查logrotate的日志</span></span><br><span class="line">gitlab-ctl tail logrotate</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查nginx的日志</span></span><br><span class="line">gitlab-ctl tail nginx</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查sidekiq的日志</span></span><br><span class="line">gitlab-ctl tail sidekiq</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> 检查unicorn的日志</span></span><br><span class="line">gitlab-ctl tail unicorn</span><br></pre></td></tr></table></figure>
<h3 id="3-3、备份"><a href="#3-3、备份" class="headerlink" title="3.3、备份"></a>3.3、备份</h3><p><strong>3.3.1、手动备份：</strong><br>gitLab默认备份的目录为  /var/opt/gitlab/backups，如果想改备份目录，可修改/etc/gitlab/gitlab.rb：</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab_rails[<span class="string">'backup_path'</span>] = <span class="string">'/data/backups'</span></span><br></pre></td></tr></table></figure>
<p>修改文件后，需要<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@sjq</span><span class="number">-09</span> ~]<span class="meta"># gitlab-ctl reconfigure</span></span><br></pre></td></tr></table></figure></p>
<p>备份命令:<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@sjq-09 ~]</span># <span class="selector-tag">gitlab-rake</span> <span class="selector-tag">gitlab</span><span class="selector-pseudo">:backup</span><span class="selector-pseudo">:create</span></span><br></pre></td></tr></table></figure></p>
<p>该命令会在备份目录（默认：/var/opt/gitlab/backups/）下创建一个tar压缩包xxxxxxxx_gitlab_backup.tar，其中开头的xxxxxx是备份创建的时间戳，这个压缩包包括GitLab整个的完整部分。</p>
<p><strong>3.3.2、使用 crontab实现自动备份</strong></p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@sjq</span>-09 ~]<span class="comment"># crontab -e</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 每天2点备份gitlab数据</span></span><br><span class="line"><span class="number">0</span> <span class="number">2</span> * * * <span class="regexp">/usr/bin</span><span class="regexp">/gitlab-rake gitlab:backup:create</span></span><br></pre></td></tr></table></figure>
<p>可设置只保留最近7天的备份，编辑配置文件 /etc/gitlab/gitlab.rb<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 数值单位：秒</span></span><br><span class="line">gitlab_rails[<span class="string">'backup_keep_time'</span>] = <span class="number">604800</span></span><br></pre></td></tr></table></figure></p>
<p>重新加载gitlab配置文件<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@sjq</span><span class="number">-09</span> ~]<span class="meta"># gitlab-ctl reconfigure</span></span><br></pre></td></tr></table></figure></p>
<h3 id="3-4、恢复"><a href="#3-4、恢复" class="headerlink" title="3.4、恢复"></a>3.4、恢复</h3><p>假设配置文件为: /var/opt/gitlab/backups/1499444722_2018_05_28_7.4.7_gitlab_backup.tar</p>
<p>停止 unicorn 和 sidekiq ，保证数据库没有新的连接，不会有写数据情况。</p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止相关数据连接服务</span></span><br><span class="line">[root@sjq<span class="number">-09</span> ~]<span class="comment"># gitlab-ctl stop unicorn</span></span><br><span class="line">[root@sjq<span class="number">-09</span> ~]<span class="comment"># gitlab-ctl stop sidekiq</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定恢复文件，会自动去备份目录找。确保备份目录中有这个文件。</span></span><br><span class="line"><span class="comment"># 指定文件名的格式类似：1499444722_2018_05_28_7.4.7，程序会自动在文件名后补上：“_gitlab_backup.tar”</span></span><br><span class="line"><span class="comment"># 一定按这样的格式指定，否则会出现 The backup file does not exist! 的错误</span></span><br><span class="line">[root@sjq<span class="number">-09</span> ~]<span class="comment"># gitlab-rake gitlab:backup:restore BACKUP=1499444722_2018_05_28_7.4.7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Gitlab</span></span><br><span class="line">[root@sjq<span class="number">-09</span> ~]<span class="comment"># gitlab-ctl start</span></span><br></pre></td></tr></table></figure>
<h3 id="3-5、开机自启"><a href="#3-5、开机自启" class="headerlink" title="3.5、开机自启"></a>3.5、开机自启</h3><p><code>vim /etc/rc.d/rc.local</code> 添加如下内容<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">bin/gitlab-ctl </span>start</span><br></pre></td></tr></table></figure></p>
<h3 id="3-6、数据库操作"><a href="#3-6、数据库操作" class="headerlink" title="3.6、数据库操作"></a>3.6、数据库操作</h3><p>连接数据库<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@sjq-09</span> data]<span class="comment"># gitlab-rails dbconsole</span></span><br><span class="line">psql (9.6.8)</span><br><span class="line">Type <span class="string">"help"</span> for help.</span><br><span class="line"></span><br><span class="line">gitlabhq_production=&gt; \l  <span class="comment">#查看所有数据库</span></span><br><span class="line">                                             List of databases</span><br><span class="line">        Name         |<span class="string">    Owner    </span>|<span class="string"> Encoding </span>|<span class="string">   Collate   </span>|<span class="string">    Ctype    </span>|<span class="string">        Access privileges        </span></span><br><span class="line"><span class="string">---------------------+-------------+----------+-------------+-------------+---------------------------------</span></span><br><span class="line"><span class="string"> gitlabhq_production </span>|<span class="string"> gitlab      </span>|<span class="string"> UTF8     </span>|<span class="string"> en_US.UTF-8 </span>|<span class="string"> en_US.UTF-8 </span>|<span class="string"> </span></span><br><span class="line"><span class="string"> postgres            </span>|<span class="string"> gitlab-psql </span>|<span class="string"> UTF8     </span>|<span class="string"> en_US.UTF-8 </span>|<span class="string"> en_US.UTF-8 </span>|<span class="string"> </span></span><br><span class="line"><span class="string"> template0           </span>|<span class="string"> gitlab-psql </span>|<span class="string"> UTF8     </span>|<span class="string"> en_US.UTF-8 </span>|<span class="string"> en_US.UTF-8 </span>|<span class="string"> =c/"gitlab-psql"               +</span></span><br><span class="line"><span class="string">                     </span>|<span class="string">             </span>|<span class="string">          </span>|<span class="string">             </span>|<span class="string">             </span>|<span class="string"> "gitlab-psql"=CTc/"gitlab-psql"</span></span><br><span class="line"><span class="string"> template1           </span>|<span class="string"> gitlab-psql </span>|<span class="string"> UTF8     </span>|<span class="string"> en_US.UTF-8 </span>|<span class="string"> en_US.UTF-8 </span>|<span class="string"> =c/"gitlab-psql"               +</span></span><br><span class="line"><span class="string">                     </span>|<span class="string">             </span>|<span class="string">          </span>|<span class="string">             </span>|<span class="string">             </span>|<span class="string"> "gitlab-psql"=CTc/"gitlab-psql"</span></span><br><span class="line"></span><br><span class="line"><span class="string">gitlabhq_production=&gt; \q # 退出</span></span><br></pre></td></tr></table></figure></p>
<p>默认情况下，postgresql只允许本机访问，配置访问权限</p>
<p><code>vim /var/opt/gitlab/postgresql/data/pg_hba.conf</code> 添加如下内容<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host    all     all     <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>       trust</span><br></pre></td></tr></table></figure></p>
<p><code>vim /var/opt/gitlab/postgresql/data/postgresql.conf</code> 找到 listen_addresses 设置为’*’<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">listen_addresses</span> = <span class="string">'*'</span></span><br></pre></td></tr></table></figure></p>
<p>重启 postgresql服务:</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gitlab-ctl restart postgresql</span></span><br></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/Git/">Git</a></div><div class="post-share"><div class="bdsharebuttonbox"><span style="float:left;line-height: 28px;height: 28px;font-size:16px;font-weight:blod">分享到：</span><a href="#" data-cmd="more" class="bds_more"></a><a href="#" data-cmd="mshare" title="分享到一键分享" class="bds_mshare"></a><a href="#" data-cmd="fbook" title="分享到Facebook" class="bds_fbook"></a><a href="#" data-cmd="twi" title="分享到Twitter" class="bds_twi"></a><a href="#" data-cmd="linkedin" title="分享到linkedin" class="bds_linkedin"></a><a href="#" data-cmd="youdao" title="分享到有道云笔记" class="bds_youdao"></a><a href="#" data-cmd="evernotecn" title="分享到印象笔记" class="bds_evernotecn"></a><a href="#" data-cmd="weixin" title="分享到微信" class="bds_weixin"></a><a href="#" data-cmd="qzone" title="分享到QQ空间" class="bds_qzone"></a><a href="#" data-cmd="tsina" title="分享到新浪微博" class="bds_tsina"></a></div></div><div class="post-nav"><a href="/2018/07/09/01_Hadoop介绍与集群配置/" class="pre">Hadoop简介与安装</a><a href="/2018/07/09/Git_03_多账号配置SSH/" class="next">Git 多账号配置SSH</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#一、GitLab-简介"><span class="toc-text">一、GitLab 简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#二、GitLab-安装和配置"><span class="toc-text">二、GitLab 安装和配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1、GitLab安装"><span class="toc-text">2.1、GitLab安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2、配置："><span class="toc-text">2.2、配置：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、gitLab服务管理"><span class="toc-text">三、gitLab服务管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1、服务管理"><span class="toc-text">3.1、服务管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2、日志管理"><span class="toc-text">3.2、日志管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3、备份"><span class="toc-text">3.3、备份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4、恢复"><span class="toc-text">3.4、恢复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5、开机自启"><span class="toc-text">3.5、开机自启</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6、数据库操作"><span class="toc-text">3.6、数据库操作</span></a></li></ol></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/07/09/vue_01/">Vue 简介</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/09/Browsersync/">browsersync(浏览器同步工具)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/09/Redis_06_主从复制(哨兵机制)/">Redis 主从复制</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/09/10_其它改进/">其它改进</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/09/09_http改进/">全新的HTTP API</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/09/08_Stream改进/">API改进_Stream API</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/09/07_集合改进/">API改进_集合</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/09/06_标识符&String/">语法改进_标识符&String</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/09/05_异常处理/">语法改进_try</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/09/04_钻石操作符/">语法改进_钻石操作符(泛型 [Diamond operator])</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/Redis/" style="font-size: 15px;">Redis</a> <a href="/tags/ETL/" style="font-size: 15px;">ETL</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/JPA/" style="font-size: 15px;">JPA</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Mac/" style="font-size: 15px;">Mac</a> <a href="/tags/MySql/" style="font-size: 15px;">MySql</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Idea/" style="font-size: 15px;">Idea</a> <a href="/tags/Tool/" style="font-size: 15px;">Tool</a> <a href="/tags/Spring-Cloud/" style="font-size: 15px;">Spring Cloud</a> <a href="/tags/Spring-Boot/" style="font-size: 15px;">Spring-Boot</a> <a href="/tags/Svn/" style="font-size: 15px;">Svn</a> <a href="/tags/Thymeleaf/" style="font-size: 15px;">Thymeleaf</a> <a href="/tags/Hadoop/" style="font-size: 15px;">Hadoop</a> <a href="/tags/JDK9/" style="font-size: 15px;">JDK9</a> <a href="/tags/Vue/" style="font-size: 15px;">Vue</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">Huangkai.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","weixin","tsina","qzone","linkedin","fbook","twi","print","renren","sqq","evernotecn","bdysc","tqq","tqf","bdxc","kaixin001","tieba","douban","bdhome","thx","ibaidu","meilishuo","mogujie","diandian","huaban","duitang","hx","fx","youdao","sdo","qingbiji","people","xinhua","mail","isohu","yaolan","wealink","ty","iguba","h163","copy"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","weixin","fbook","twi","linkedin","youdao","evernotecn","mshare"]}};with(document)0[(getElementsByTagName('head')[0]||head).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script></body></html>